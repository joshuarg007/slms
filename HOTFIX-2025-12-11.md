# Hotfix Log - December 11, 2025

## Issue: Production 500 Internal Server Errors

### Symptoms
- All authenticated API endpoints returning 500 errors
- `/api/dashboard/metrics`, `/api/integrations/crm/active`, `/api/leads`, etc.
- Unauthenticated requests returned proper 401 (so issue was post-auth)

### Root Causes

1. **SQLAlchemy 2.0 Deprecation** (Code fix)
   - `db.query(Model).get(id)` deprecated in SQLAlchemy 2.0
   - Fixed in: `app/api/deps/subscription.py`, `app/crud/lead.py`
   - Changed to: `db.get(Model, id)`

2. **Missing `get_lead_metrics` function** (Code fix)
   - Dashboard route called `lead_crud.get_lead_metrics(db)` but function didn't exist
   - Added to `app/crud/lead.py` with dialect-aware SQL (PostgreSQL vs SQLite)

3. **Missing Database Columns** (Production DB fix)
   - Production PostgreSQL was missing columns that existed in model definitions
   - Alembic migrations had not been applied

### Production Database Fixes Applied (via SSM)

```sql
-- Organizations table
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS ai_messages_this_month INTEGER DEFAULT 0;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS ai_messages_month_reset TIMESTAMP;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS active_crm VARCHAR(20) DEFAULT 'hubspot';

-- Leads table
ALTER TABLE leads ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'new';
ALTER TABLE leads ADD COLUMN IF NOT EXISTS deal_value NUMERIC(12,2);
ALTER TABLE leads ADD COLUMN IF NOT EXISTS closed_at TIMESTAMP;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_engagement INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_source INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_value INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_velocity INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_fit INTEGER;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS win_probability FLOAT;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS score_updated_at TIMESTAMP;
ALTER TABLE leads ADD COLUMN IF NOT EXISTS assigned_user_id INTEGER;
```

### Commits

- `6e93228` - Fix SQLAlchemy 2.0 deprecated Query.get() calls
- `20f2e42` - Fix remaining SQLAlchemy 2.0 deprecated Query.get() calls
- `7ec7ae9` - Add missing get_lead_metrics function for dashboard

### Lessons Learned

1. Alembic migrations need to be verified on production after deploy
2. SQLAlchemy 2.0 migration requires updating `Query.get()` patterns
3. CloudFront can cache 500 errors - invalidation may be needed after fixes
4. Always test authenticated requests, not just unauthenticated ones

### AWS Services Involved

- **CloudFront**: CDN caching (required invalidation)
- **EC2**: Backend server (via SSM for access)
- **SSM**: Systems Manager for remote commands
- **PostgreSQL**: Production database (RDS or local)
