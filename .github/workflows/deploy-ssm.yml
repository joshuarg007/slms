name: Deploy Backend (SSM)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Send SSM deploy command
        id: send
        run: |
          set -euo pipefail
          CMD_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.SSM_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Site2CRM via SSM" \
            --parameters commands='[
              "#!/bin/bash",
              "set -euo pipefail",
              "export HOME=/root",
              "cd /home/ubuntu/site2crm",
              "git config --global --add safe.directory /home/ubuntu/site2crm",
              "git fetch --all --prune",
              "git reset --hard origin/main",
              "/opt/site2crm/.venv/bin/pip install --upgrade pip",
              "/opt/site2crm/.venv/bin/pip install -r requirements.txt",
              "[ -f alembic.ini ] && /opt/site2crm/.venv/bin/alembic upgrade heads || true",
              "sudo systemctl daemon-reload",
              "sudo systemctl restart site2crm",
              "sudo systemctl reload nginx || true",
              "sudo systemctl --no-pager -l status site2crm || true"
            ]' \
            --query "Command.CommandId" --output text)
          echo "command_id=$CMD_ID" >> $GITHUB_OUTPUT

      - name: Wait for SSM command to finish
        run: |
          set -euo pipefail
          CMD_ID="${{ steps.send.outputs.command_id }}"
          INST="${{ secrets.SSM_INSTANCE_ID }}"
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$INST" --query "Status" --output text || true)
            echo "Status: $STATUS"
            if [ "$STATUS" = "Success" ]; then break; fi
            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then exit 1; fi
            sleep 10
          done
          aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$INST" --query 'StandardOutputContent' --output text || true
          aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$INST" --query 'StandardErrorContent' --output text || true
